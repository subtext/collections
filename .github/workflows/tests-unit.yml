name: Run Unit Tests

on:
  pull_request:
    types:
      - "opened"
      - "reopened"
      - "synchronize"
    branches:
      - master

jobs:
  phpunit_test:
    name: "Unit Test"
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Compose Up
        run: docker compose up -d

      - name: Docker Compose PS
        run: docker compose ps

      - name: Run Composer Install
        run: docker exec collections-php-apache-1 composer install

      - name: Run Unit Tests
        run: docker exec collections-php-apache-1 vendor/bin/phpunit

      - name: Check Coverage Threshold
        run: |
          FILE=clover/clover.xml
          
          if [ ! -f "$FILE" ]; then
            echo "‚ùå Coverage report not found at $FILE"
            exit 1
          fi
          
          COVERED=$(xmllint --xpath 'string(//project/metrics/@coveredstatements)' "$FILE")
          TOTAL=$(xmllint --xpath 'string(//project/metrics/@statements)' "$FILE")
          
          if [ -z "$COVERED" ] || [ -z "$TOTAL" ] || [ "$TOTAL" -eq 0 ]; then
            echo "‚ö†Ô∏è Error parsing coverage"
            exit 1
          fi
          PERCENT=$(awk "BEGIN {printf \"%.2f", ($COVERED/$TOTAL) * 100 }")
          echo "üìàCode Coverage: $PERCENT%"
                    
          
          # Check threshold
          THRESHOLD=90
          if (( $(awk "BEGIN {print ($PERCENT < $THRESHOLD)}") )); then
            echo "‚ùå Coverage $PERCENT% is below required $THRESHOLD%"
            exit 1
          else
            echo "‚úÖ Coverage $PERCENT% meets threshold"
          fi

